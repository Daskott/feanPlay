function timeStamp(){var e=new Date,o=([e.getMonth()+1,e.getDate(),e.getFullYear()],[e.getHours(),e.getMinutes(),e.getSeconds()]),t=o[0]<12?"AM":"PM";o[0]=o[0]<12?o[0]:o[0]-12,o[0]=o[0]||12;for(var r=1;3>r;r++)o[r]<10&&(o[r]="0"+o[r]);return o.join(":")+" "+t}function writeNewPost(e,o,t,r,a,n,s,l,i){var u=new Date,c=months[u.getMonth()+1],f=c+" "+u.getDate()+" "+u.getFullYear()+" - "+timeStamp(),d={username:o,fullname:t,title:r,body:a,type:n,tags:s,image:l,color:i,time:f,key:"",voteCount:0,votes:{},uid:e},p=firebase.database().ref("posts").push().key;d.key=p;var g={};return g["/posts/"+p]=d,g["/user-posts/"+e+"/"+p]=d,firebase.database().ref().update(g)}function getRandomColor(){var e=Math.floor(Math.random()*colors.length);return colors[e]}function JsonToArray(e){return e?Object.keys(e).map(function(o){return e[o]}):[]}var config={apiKey:"AIzaSyDLjZr8hIFMjkrNt_Jya3br6U0R8jHT1Zs",authDomain:"jabber-7319f.firebaseapp.com",databaseURL:"https://jabber-7319f.firebaseio.com",storageBucket:"jabber-7319f.appspot.com"};firebase.initializeApp(config);var app=angular.module("app",["ngRoute","ngCookies","ngSanitize","ngTagsInput","firebase"]);angular.module("app").controller("ApplicationCtrl",["$scope","$rootScope","$location","UserService",function(e,o,t,r){e.currentUser=o.globals.currentUser,function(){e.nav=0,"/home"==t.path()?e.nav=0:"/connect"==t.path()&&(e.nav=1)}(),e.$on("login",function(){e.currentUser=o.globals.currentUser}),e.setNav=function(o){e.nav=o},e.isSelectedNav=function(o){return e.nav===o},e.logout=function(){r.clearCredentials(),t.path("/"),e.currentUser=null,e.nav=0,firebase.auth().signOut().then(function(){console.log("signed out")},function(e){})}}]);var app=angular.module("app");app.controller("ConnectCtrl",["$scope","$rootScope","$firebaseArray","UserService",function(e,o,t,r){var a=firebase.database().ref().child("users"),n=firebase.database().ref().child("users/"+e.currentUser.uid+"/followees");n.on("child_added",function(e){r.follow(e.val())}),n.on("child_removed",function(e){r.unFollow(e.val())}),e.users=t(a),e.toggleFollow=function(o){var t=e.isFollowing(o.username);if(selectedUserName=o.username,t){var a={};a["users/"+e.currentUser.uid+"/followees/"+o.uid]=null,a["users/"+o.uid+"/followers/"+e.currentUser.uid]=null,firebase.database().ref().update(a),r.unFollow(selectedUserName)}else{var a={};a["users/"+e.currentUser.uid+"/followees/"+o.uid]=selectedUserName,a["users/"+o.uid+"/followers/"+e.currentUser.uid]=e.currentUser.username,firebase.database().ref().update(a),r.follow(selectedUserName)}},e.isFollowing=function(o){return e.currentUser?r.isFollowing(o):void 0},firebase.auth().onAuthStateChanged(function(e){e||a.off()})}]),angular.module("app").controller("ForgotPasswordCtrl",["$scope",function(e){e.emailSent=!1,e.errorMessage,e.sendResetEmail=function(o){if(o){var t=firebase.auth(),r=o;e.dataLoading=!0,t.sendPasswordResetEmail(r).then(function(){e.$apply(function(){e.dataLoading=!1,e.emailSent=!0,e.errorMessage=null})},function(o){e.$apply(function(){e.dataLoading=!1,e.errorMessage=o.message}),console.log(o.message)})}}}]);var app=angular.module("app");app.controller("LoginCtrl",["$scope","$rootScope","$location","UserService",function(e,o,t,r){var a=firebase.auth();e.invalidLogin=!1,e.login=function(o,n){e.dataLoading=!0,e.errorMessage=null,null!=o&&null!=n||(e.dataLoading=!1),a.signInWithEmailAndPassword(o,n).then(function(o){firebase.database().ref("/users/"+o.uid).once("value").then(function(o){var a=o.val();r.clearCredentials(),r.setCredentials(a),e.$apply(function(){e.dataLoading=!1,e.invalidLogin=!1,e.errorMessage=null,e.$emit("login"),t.path("/home")})})})["catch"](function(o){o.code;e.$apply(function(){e.dataLoading=!1,e.errorMessage=o.message})})}}]);var app=angular.module("app");app.controller("PostsCtrl",["$scope","$firebaseArray","$http","PostsService","UserService",function(e,o,t,r,a){e.postSelection=0,e.question=null,e.answer=null;var n=firebase.database().ref().child("posts");e.posts=o(n),e.addPost=function(){0===e.postSelection?e.postBody&&(writeNewPost(e.currentUser.uid,e.currentUser.username,e.currentUser.fullname,"Post-Title",e.postBody,"Text","No-tags",e.photo||"",e.currentUser.color),e.postBody=null):1===e.postSelection&&e.question&&e.answer&&(writeNewPost(e.currentUser.uid,e.currentUser.username,e.currentUser.fullname,e.question,e.answer,"K-bits",e.tags,e.photo||"",e.currentUser.color),e.question=null,e.answer=null)},e.isValidPost=function(){return 0===e.postSelection?!!e.postBody:1===e.postSelection?!(!e.question||!e.answer):void 0},e.isPostForMe=function(o,t){return e.currentUser?e.currentUser.uid===t?!0:a.isFollowing(o):void 0},e.toggleVote=function(o,t){var r=firebase.database().ref().child("posts/"+o),a=e.currentUser.uid;r.transaction(function(e){return e.votes&&e.votes[a]?(e.voteCount--,e.votes[a]=null):(e.voteCount++,e.votes||(e.votes={}),e.votes[a]=!0),firebase.database().ref().child("user-posts/"+t+"/"+o+"/votes/"+a).set(e.votes[a]),firebase.database().ref().child("user-posts/"+t+"/"+o+"/voteCount").set(e.voteCount),e})},e.votedThisPost=function(o){return!(!o||!o[e.currentUser.uid])},e.setPostType=function(o){e.postSelection=o},e.isSelectedPost=function(o){return e.postSelection===o},e.tags=[{text:"Joke"},{text:"Riddle"}],e.loadTags=function(e){return t.get("tags.json")},firebase.auth().onAuthStateChanged(function(e){e||n.off()})}]);var months=["January","February","March","April","May","June","July","August","September","October","November","December"],app=angular.module("app");app.service("PostsService",["$http",function(e){this.fetch=function(){return e.get("/api/posts")},this.create=function(o){return e.post("/api/posts",o)}}]);var app=angular.module("app");app.controller("RegisterCtrl",["$scope","$location","UserService",function(e,o,t){e.register=function(r,a,n,s){e.dataLoading=!0,r&&a&&s&&n&&t.validUserName(a,function(l){l?firebase.auth().createUserWithEmailAndPassword(n,s).then(function(n){var s={uid:n.uid,fullname:r,username:a,email:n.email,followees:{},followers:{},color:getRandomColor()};firebase.database().ref("users/"+s.uid).set(s),firebase.database().ref("jb_usernames/"+s.uid).set(s.username),t.setCredentials(s),e.$apply(function(){e.$emit("login"),o.path("/home")})})["catch"](function(o){var t=(o.code,o.message);console.log(t),e.$apply(function(){e.dataLoading=!1,e.errorMessage=t})}):e.$apply(function(){e.errorMessage="Please choose another username, '"+a+"' is already taken.",e.dataLoading=!1})})}}]);var colors=["#ef5350","#9C27B0","#FF5722","#795548","#FFC107","#4CAF50","#009688","#00BCD4","#03A9F4","#2196F3","#3F51B5","#673AB7","#263238","#33691E","#c0392b","#e74c3c","#2980b9","#3498db","#f1c40f","#9b59b6","#a0522d"];!function(){"use strict";function e(e,o){e.when("/home",{controller:"PostsCtrl",templateUrl:"posts.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"register.html"}).when("/forgotPassword",{controller:"ForgotPasswordCtrl",templateUrl:"forgotPassword.html"}).when("/connect",{controller:"ConnectCtrl",templateUrl:"connect.html"}).when("/",{controller:"LoginCtrl",templateUrl:"login.html"}).otherwise({redirectTo:"/"})}function o(e,o,t,r){firebase.auth().onAuthStateChanged(function(e){e||(r.defaults.headers.common["x-auth"]=null,t.remove("globals"),o.path("/"))}),e.globals=t.get("globals")||{},e.globals.currentUser&&(r.defaults.headers.common["x-auth"]=e.globals.currentUser.authdata),e.$on("$locationChangeStart",function(t,r,a){var n=-1===$.inArray(o.path(),["/","/register","/forgotPassword"]),s=e.globals.currentUser;n&&!s&&o.path("/"),s&&"/"==o.path()&&o.path("/home")})}angular.module("app").config(e).run(o),e.$inject=["$routeProvider","$locationProvider"],o.$inject=["$rootScope","$location","$cookieStore","$http"]}();var app=angular.module("app");app.service("UserService",["$http","$rootScope","$cookieStore",function(e,o,t){var r=this;r.setCredentials=function(r){var a="token";o.globals={currentUser:{username:r.username,fullname:r.fullname,email:r.email,color:r.color,uid:r.uid,followees:JsonToArray(r.followees),authdata:a}};JsonToArray(o.globals.currentUser.followees);t.put("globals",o.globals),e.defaults.headers.common["x-auth"]=a},r.clearCredentials=function(){o.globals={},t.remove("globals"),e.defaults.headers.common.Authorization=null},r.validUserName=function(e,o){firebase.database().ref("/jb_usernames").once("value").then(function(t){var r=!0,a=t.val();if(a){var n=JsonToArray(a);n.indexOf(e)>-1&&(r=!1)}o(r)})},r.isFollowing=function(e){var t=o.globals.currentUser.followees;return t.indexOf(e)>-1},r.follow=function(e){o.globals.currentUser.followees.indexOf(e)<=-1&&(o.globals.currentUser.followees.push(e),t.remove("globals"),t.put("globals",o.globals))},r.unFollow=function(e){var r=o.globals.currentUser.followees;index=r.indexOf(e),index>-1&&(r[index]=""),o.globals.currentUser.followees=r,t.remove("globals"),t.put("globals",o.globals)}}]);