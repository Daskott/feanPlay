function timeStamp(){var e=new Date,r=([e.getMonth()+1,e.getDate(),e.getFullYear()],[e.getHours(),e.getMinutes(),e.getSeconds()]),o=r[0]<12?"AM":"PM";r[0]=r[0]<12?r[0]:r[0]-12,r[0]=r[0]||12;for(var a=1;3>a;a++)r[a]<10&&(r[a]="0"+r[a]);return r.join(":")+" "+o}function writeNewPost(e,r,o,a,t,n){var s=new Date,l=months[s.getMonth()+1],i=l+" "+s.getDate()+" "+s.getFullYear()+" - "+timeStamp(),u={username:r,fullname:o,body:a,image:t,color:n,time:i,key:"",voteCount:0,uid:e},c=firebase.database().ref("posts").push().key;u.key=c;var f={};return f["/posts/"+c]=u,f["/user-posts/"+e+"/"+c]=u,firebase.database().ref().update(f)}function getRandomColor(){var e=Math.floor(Math.random()*colors.length);return colors[e]}function JsonToArray(e){return e?Object.keys(e).map(function(r){return e[r]}):[]}var config={apiKey:"AIzaSyDLjZr8hIFMjkrNt_Jya3br6U0R8jHT1Zs",authDomain:"jabber-7319f.firebaseapp.com",databaseURL:"https://jabber-7319f.firebaseio.com",storageBucket:"jabber-7319f.appspot.com"};firebase.initializeApp(config);var app=angular.module("app",["ngRoute","ngCookies","ngSanitize","firebase"]);angular.module("app").controller("ApplicationCtrl",["$scope","$rootScope","$location","UserService",function(e,r,o,a){e.currentUser=r.globals.currentUser,function(){e.nav=0,"/home"==o.path()?e.nav=0:"/connect"==o.path()&&(e.nav=1)}(),e.$on("login",function(){e.currentUser=r.globals.currentUser}),e.setNav=function(r){e.nav=r},e.isSelectedNav=function(r){return e.nav===r},e.logout=function(){a.clearCredentials(),o.path("/"),e.currentUser=null,e.nav=0,firebase.auth().signOut().then(function(){console.log("signed out")},function(e){})}}]);var app=angular.module("app");app.controller("ConnectCtrl",["$scope","$rootScope","$firebaseArray","UserService",function(e,r,o,a){var t=firebase.database().ref().child("users"),n=firebase.database().ref().child("users/"+e.currentUser.uid+"/followees");n.on("child_added",function(e){a.follow(e.val())}),n.on("child_removed",function(e){a.unFollow(e.val())}),e.users=o(t),e.toggleFollow=function(r){var o=e.isFollowing(r.username);if(selectedUserName=r.username,o){var t={};t["users/"+e.currentUser.uid+"/followees/"+r.uid]=null,t["followers/"+r.uid+"/"+e.currentUser.uid]=null,firebase.database().ref().update(t),a.unFollow(selectedUserName)}else{var t={};t["users/"+e.currentUser.uid+"/followees/"+r.uid]=selectedUserName,t["followers/"+r.uid+"/"+e.currentUser.uid]=e.currentUser.username,firebase.database().ref().update(t),a.follow(selectedUserName)}},e.isFollowing=function(r){return e.currentUser?a.isFollowing(r):void 0},firebase.auth().onAuthStateChanged(function(e){e||t.off()})}]),angular.module("app").controller("ForgotPasswordCtrl",["$scope",function(e){e.emailSent=!1,e.errorMessage,e.sendResetEmail=function(r){if(r){var o=firebase.auth(),a=r;e.dataLoading=!0,o.sendPasswordResetEmail(a).then(function(){e.$apply(function(){e.dataLoading=!1,e.emailSent=!0,e.errorMessage=null})},function(r){e.$apply(function(){e.dataLoading=!1,e.errorMessage=r.message}),console.log(r.message)})}}}]);var app=angular.module("app");app.controller("LoginCtrl",["$scope","$rootScope","$location","UserService",function(e,r,o,a){var t=firebase.auth();e.invalidLogin=!1,e.login=function(r,n){e.dataLoading=!0,e.errorMessage=null,t.signInWithEmailAndPassword(r,n).then(function(r){firebase.database().ref("/users/"+r.uid).once("value").then(function(r){var t=r.val();a.clearCredentials(),a.setCredentials(t),e.$apply(function(){e.dataLoading=!1,e.invalidLogin=!1,e.errorMessage=null,e.$emit("login"),o.path("/home")})})})["catch"](function(r){r.code;e.$apply(function(){e.dataLoading=!1,e.errorMessage=r.message})})}}]);var app=angular.module("app");app.controller("PostsCtrl",["$scope","$firebaseArray","PostsService","UserService",function(e,r,o,a){var t=firebase.database().ref().child("posts");e.posts=r(t),e.addPost=function(){e.postBody&&writeNewPost(e.currentUser.uid,e.currentUser.username,e.currentUser.fullname,e.postBody,e.photo||"",e.currentUser.color),e.postBody=null},e.isPostForMe=function(r,o){return e.currentUser?e.currentUser.uid===o?!0:a.isFollowing(r):void 0},firebase.auth().onAuthStateChanged(function(e){e||t.off()})}]);var months=["January","February","March","April","May","June","July","August","September","October","November","December"],app=angular.module("app");app.service("PostsService",["$http",function(e){this.fetch=function(){return e.get("/api/posts")},this.create=function(r){return e.post("/api/posts",r)}}]);var app=angular.module("app");app.controller("RegisterCtrl",["$scope","$location","UserService",function(e,r,o){e.register=function(a,t,n,s){e.dataLoading=!0,a&&t&&s&&n&&o.validUserName(t,function(l){l?firebase.auth().createUserWithEmailAndPassword(n,s).then(function(n){var s={uid:n.uid,fullname:a,username:t,email:n.email,color:getRandomColor()};firebase.database().ref("users/"+s.uid).set(s),firebase.database().ref("jb_usernames/"+s.uid).set(s.username),o.setCredentials(s),e.$apply(function(){e.$emit("login"),r.path("/home")})})["catch"](function(r){var o=(r.code,r.message);console.log(o),e.$apply(function(){e.dataLoading=!1,e.errorMessage=o})}):e.$apply(function(){e.errorMessage="Please choose another username, '"+t+"' is already taken.",e.dataLoading=!1})})}}]);var colors=["#ef5350","#9C27B0","#FF5722","#795548","#FFC107","#4CAF50","#009688","#00BCD4","#03A9F4","#2196F3","#3F51B5","#673AB7","#263238","#33691E","#c0392b","#e74c3c","#2980b9","#3498db","#f1c40f","#9b59b6","#a0522d"];!function(){"use strict";function e(e,r){e.when("/home",{controller:"PostsCtrl",templateUrl:"posts.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"register.html"}).when("/forgotPassword",{controller:"ForgotPasswordCtrl",templateUrl:"forgotPassword.html"}).when("/connect",{controller:"ConnectCtrl",templateUrl:"connect.html"}).when("/",{controller:"LoginCtrl",templateUrl:"login.html"}).otherwise({redirectTo:"/"})}function r(e,r,o,a){firebase.auth().onAuthStateChanged(function(e){e||(a.defaults.headers.common["x-auth"]=null,o.remove("globals"),r.path("/"))}),e.globals=o.get("globals")||{},e.globals.currentUser&&(a.defaults.headers.common["x-auth"]=e.globals.currentUser.authdata),e.$on("$locationChangeStart",function(o,a,t){var n=-1===$.inArray(r.path(),["/","/register","/forgotPassword"]),s=e.globals.currentUser;n&&!s&&r.path("/"),s&&"/"==r.path()&&r.path("/home")})}angular.module("app").config(e).run(r),e.$inject=["$routeProvider","$locationProvider"],r.$inject=["$rootScope","$location","$cookieStore","$http"]}();var app=angular.module("app");app.service("UserService",["$http","$rootScope","$cookieStore",function(e,r,o){var a=this;a.setCredentials=function(a){var t="token";r.globals={currentUser:{username:a.username,fullname:a.fullname,email:a.email,color:a.color,uid:a.uid,followees:JsonToArray(a.followees),authdata:t}};JsonToArray(r.globals.currentUser.followees);o.put("globals",r.globals),e.defaults.headers.common["x-auth"]=t},a.clearCredentials=function(){r.globals={},o.remove("globals"),e.defaults.headers.common.Authorization=null},a.validUserName=function(e,r){firebase.database().ref("/jb_usernames").once("value").then(function(o){var a=!0,t=o.val();if(t){var n=JsonToArray(t);n.indexOf(e)>-1&&(a=!1)}r(a)})},a.isFollowing=function(e){var o=r.globals.currentUser.followees;return o.indexOf(e)>-1},a.follow=function(e){r.globals.currentUser.followees.indexOf(e)<=-1&&(r.globals.currentUser.followees.push(e),o.remove("globals"),o.put("globals",r.globals))},a.unFollow=function(e){var a=r.globals.currentUser.followees;index=a.indexOf(e),index>-1&&(a[index]=""),r.globals.currentUser.followees=a,o.remove("globals"),o.put("globals",r.globals)}}]);