function timeStamp(){var e=new Date,t=([e.getMonth()+1,e.getDate(),e.getFullYear()],[e.getHours(),e.getMinutes(),e.getSeconds()]),o=t[0]<12?"AM":"PM";t[0]=t[0]<12?t[0]:t[0]-12,t[0]=t[0]||12;for(var n=1;3>n;n++)t[n]<10&&(t[n]="0"+t[n]);return t.join(":")+" "+o}function timeOffEvent(){var e=new Date,t=months[e.getMonth()+1],o=t+" "+e.getDate()+" "+e.getFullYear()+" - "+timeStamp();return o}function writeNewPost(e,t,o,n,a,r,s,i,l,u){var c=new Date,f=(months[c.getMonth()+1],timeOffEvent()),d={username:t,fullname:o,title:n,body:a,type:r,tags:s,image:i,color:l,time:f,key:u,voteCount:0,votes:{},uid:e},p={};return p["/posts/"+d.key]=d,p["/user-posts/"+e+"/"+d.key]=d,firebase.database().ref().update(p)}function getRandomColor(){var e=Math.floor(Math.random()*colors.length);return colors[e]}function JsonToArray(e){return e?Object.keys(e).map(function(t){return e[t]}):[]}var config={apiKey:"AIzaSyDLjZr8hIFMjkrNt_Jya3br6U0R8jHT1Zs",authDomain:"jabber-7319f.firebaseapp.com",databaseURL:"https://jabber-7319f.firebaseio.com",storageBucket:"jabber-7319f.appspot.com"};firebase.initializeApp(config);var app=angular.module("app",["ngRoute","ngCookies","ngSanitize","ngTagsInput","firebase"]);angular.module("app").controller("ApplicationCtrl",["$scope","$rootScope","$firebaseArray","$location","UserService",function(e,t,o,n,a){e.currentUser=t.globals.currentUser,e.notifications=[],e.notificationPosts=[],e.notificatonCount=0,function(){e.nav=0,"/home"==n.path()?e.nav=0:"/connect"==n.path()&&(e.nav=1)}(),e.$on("login",function(){e.currentUser=t.globals.currentUser,e.listenForNotification()}),e.listenForNotification=function(){var t=firebase.database().ref().child("users/"+e.currentUser.uid+"/notifications");t.on("child_added",function(t){e.notifications.push(t.val()),e.getNotificationPosts(),e.setNotificationCount(),e.seenNotification=!1}),t.on("child_removed",function(t){e.notifications=[],e.notificationPosts=[]})},e.setNav=function(t){e.nav=t},e.isSelectedNav=function(t){return e.nav===t},e.setNotificationCount=function(){e.notificatonCount=0;for(var t=0;t<e.notifications.length;t++)e.notifications[t].seen===!1&&e.notificatonCount++},e.seeNotification=function(){for(var t=0;t<e.notifications.length;t++)firebase.database().ref().child("users/"+e.currentUser.uid+"/notifications/"+e.notifications[t].key+"/seen").set(!0),e.notifications[t].seen=!0;e.seenNotification=!0,e.notificatonCount=0},e.getNotificationPosts=function(){e.currentUser.uid;e.notificationPosts=[];for(var t=0;t<e.notifications.length;t++)firebase.database().ref("/posts/"+e.notifications[t].itemId).once("value").then(function(t){var o=t.val();e.notificationPosts.unshift(o)})},e.logout=function(){a.clearCredentials(),n.path("/"),e.currentUser=null,e.nav=0,firebase.auth().signOut().then(function(){console.log("signed out")},function(e){})},firebase.auth().onAuthStateChanged(function(e){e||notificationRef.off()}),e.currentUser&&e.listenForNotification()}]);var app=angular.module("app");app.controller("ConnectCtrl",["$scope","$rootScope","$firebaseArray","UserService",function(e,t,o,n){var a=firebase.database().ref().child("users"),r=firebase.database().ref().child("users/"+e.currentUser.uid+"/followees");r.on("child_added",function(e){n.follow(e.val())}),r.on("child_removed",function(e){n.unFollow(e.val())}),e.users=o(a),e.toggleFollow=function(t){var o=e.isFollowing(t.username);if(selectedUserName=t.username,o){var a={};a["users/"+e.currentUser.uid+"/followees/"+t.uid]=null,a["users/"+t.uid+"/followers/"+e.currentUser.uid]=null,firebase.database().ref().update(a),n.unFollow(selectedUserName)}else{var a={};a["users/"+e.currentUser.uid+"/followees/"+t.uid]=selectedUserName,a["users/"+t.uid+"/followers/"+e.currentUser.uid]=e.currentUser.username,firebase.database().ref().update(a),n.follow(selectedUserName)}},e.isFollowing=function(t){return e.currentUser?n.isFollowing(t):void 0},firebase.auth().onAuthStateChanged(function(e){e||a.off()})}]),angular.module("app").controller("ForgotPasswordCtrl",["$scope",function(e){e.emailSent=!1,e.errorMessage,e.sendResetEmail=function(t){if(t){var o=firebase.auth(),n=t;e.dataLoading=!0,o.sendPasswordResetEmail(n).then(function(){e.$apply(function(){e.dataLoading=!1,e.emailSent=!0,e.errorMessage=null})},function(t){e.$apply(function(){e.dataLoading=!1,e.errorMessage=t.message}),console.log(t.message)})}}}]);var app=angular.module("app");app.controller("LoginCtrl",["$scope","$rootScope","$location","UserService",function(e,t,o,n){var a=firebase.auth();e.invalidLogin=!1,e.login=function(t,r){e.dataLoading=!0,e.errorMessage=null,null!=t&&null!=r||(e.dataLoading=!1),a.signInWithEmailAndPassword(t,r).then(function(t){firebase.database().ref("/users/"+t.uid).once("value").then(function(t){var a=t.val();n.clearCredentials(),n.setCredentials(a),e.$apply(function(){e.dataLoading=!1,e.invalidLogin=!1,e.errorMessage=null,e.$emit("login"),o.path("/home")})})})["catch"](function(t){t.code;e.$apply(function(){e.dataLoading=!1,e.errorMessage=t.message})})}}]),angular.module("app").controller("NotificationCtrl",["$scope","$rootScope","$firebaseArray","$location","UserService",function(e,t,o,n,a){e.$on("$locationChangeStart",function(t,o,n){var a=e.currentUser.uid;firebase.database().ref().child("users/"+a+"/notifications").set(null),e.notificationPosts=[],e.notifications=[],e.seenNotification=!0})}]);var app=angular.module("app");app.controller("PostsCtrl",["$scope","$firebaseArray","$http","PostsService","UserService",function(e,t,o,n,a){e.postSelection=0,e.question=null,e.answer=null,e.selectedFileName="";var r=firebase.database().ref().child("posts");e.posts=t(r),e.addPost=function(){var t=document.getElementById("input").files[0],o=e.postBody,n=firebase.database().ref("posts").push().key;e.postBody=null,document.getElementById("input").value="",e.selectedFileName="",e.handleFileUpload(t,n,function(a,r){t&&a&&console.log("there was an error uploading your image"),0===e.postSelection?o&&(writeNewPost(e.currentUser.uid,e.currentUser.username,e.currentUser.fullname,"Post-Title",o,"Text","No-tags",r,e.currentUser.color,n),e.postBody=null):1===e.postSelection&&e.question&&e.answer&&(writeNewPost(e.currentUser.uid,e.currentUser.username,e.currentUser.fullname,e.question,e.answer,"K-bits",e.tags,e.photo||"",e.currentUser.color,n),e.question=null,e.answer=null)})},e.handleFileUpload=function(t,o,n){if(t&&0===e.postSelection){console.log("File: "+t.name);var a=firebase.storage().ref("posts_photos/"+e.currentUser.uid),r=a.child(o),s=r.put(t);s.on("state_changed",function(e){var t=e.bytesTransferred/e.totalBytes*100;switch(console.log("Upload is "+t+"% done"),e.state){case firebase.storage.TaskState.PAUSED:console.log("Upload is paused");break;case firebase.storage.TaskState.RUNNING:console.log("Upload is running")}},function(e){n(e,"")},function(){var e=s.snapshot.downloadURL;console.log("Done: "+e),n(null,e)})}else n(null,"")},e.isValidPost=function(){return 0===e.postSelection?!!e.postBody:1===e.postSelection?!(!e.question||!e.answer):void 0},e.isPostForMe=function(t,o){return e.currentUser?e.currentUser.uid===o?!0:a.isFollowing(t):void 0},e.toggleVote=function(t,o){var n=firebase.database().ref().child("posts/"+t),a=e.currentUser.uid;e.currentUser.username;n.transaction(function(n){return n.votes&&n.votes[a]?(n.voteCount--,n.votes[a]=null):(n.voteCount++,n.votes||(n.votes={}),n.votes[a]=!0,e.currentUser.uid!==n.uid&&e.notify(" liked your post",n.uid,n.key)),firebase.database().ref().child("user-posts/"+o+"/"+t+"/votes/"+a).set(n.votes[a]),firebase.database().ref().child("user-posts/"+o+"/"+t+"/voteCount").set(n.voteCount),n})},e.votedThisPost=function(t){return!(!t||!t[e.currentUser.uid])},e.notify=function(t,o,n){a.notify(e.currentUser.uid,e.currentUser.username,t,o,timeOffEvent(),n)},e.setPostType=function(t){e.postSelection=t,1==e.postSelection&&(document.getElementById("input").value="",e.selectedFileName="")},e.isSelectedPost=function(t){return e.postSelection===t},e.tags=[{text:"Joke"},{text:"Riddle"}],e.loadTags=function(e){return o.get("tags.json")},e.fileNameChanged=function(){e.$apply(function(){document.getElementById("input").files[0]?e.selectedFileName=document.getElementById("input").files[0].name:e.selectedFileName="",console.log("Name: "+e.selectedFileName)})},firebase.auth().onAuthStateChanged(function(e){e||r.off()})}]);var months=["January","February","March","April","May","June","July","August","September","October","November","December"],app=angular.module("app");app.service("PostsService",["$http",function(e){this.fetch=function(){return e.get("/api/posts")},this.create=function(t){return e.post("/api/posts",t)}}]);var app=angular.module("app");app.controller("RegisterCtrl",["$scope","$location","UserService",function(e,t,o){e.register=function(n,a,r,s){e.dataLoading=!0,n&&a&&s&&r&&o.validUserName(a,function(i){i?firebase.auth().createUserWithEmailAndPassword(r,s).then(function(r){var s={uid:r.uid,fullname:n,username:a,email:r.email,followees:{},followers:{},color:getRandomColor()};firebase.database().ref("users/"+s.uid).set(s),firebase.database().ref("jb_usernames/"+s.uid).set(s.username),o.setCredentials(s),e.$apply(function(){e.$emit("login"),t.path("/home")})})["catch"](function(t){var o=(t.code,t.message);console.log(o),e.$apply(function(){e.dataLoading=!1,e.errorMessage=o})}):e.$apply(function(){e.errorMessage="Please choose another username, '"+a+"' is already taken.",e.dataLoading=!1})})}}]);var colors=["#ef5350","#9C27B0","#FF5722","#795548","#FFC107","#4CAF50","#009688","#00BCD4","#03A9F4","#2196F3","#3F51B5","#673AB7","#263238","#33691E","#c0392b","#e74c3c","#2980b9","#3498db","#f1c40f","#9b59b6","#a0522d"];!function(){"use strict";function e(e,t){e.when("/home",{controller:"PostsCtrl",templateUrl:"posts.html"}).when("/register",{controller:"RegisterCtrl",templateUrl:"register.html"}).when("/forgotPassword",{controller:"ForgotPasswordCtrl",templateUrl:"forgotPassword.html"}).when("/connect",{controller:"ConnectCtrl",templateUrl:"connect.html"}).when("/notification",{controller:"NotificationCtrl",templateUrl:"notification.html"}).when("/",{controller:"LoginCtrl",templateUrl:"login.html"}).otherwise({redirectTo:"/"})}function t(e,t,o,n){firebase.auth().onAuthStateChanged(function(e){e||(n.defaults.headers.common["x-auth"]=null,o.remove("globals"),t.path("/"))}),e.globals=o.get("globals")||{},e.globals.currentUser&&(n.defaults.headers.common["x-auth"]=e.globals.currentUser.authdata),e.$on("$locationChangeStart",function(o,n,a){var r=-1===$.inArray(t.path(),["/","/register","/forgotPassword"]),s=e.globals.currentUser;r&&!s&&t.path("/"),s&&"/"===t.path()&&t.path("/home")})}angular.module("app").config(e).run(t),e.$inject=["$routeProvider","$locationProvider"],t.$inject=["$rootScope","$location","$cookieStore","$http"]}();var app=angular.module("app");app.service("UserService",["$http","$rootScope","$cookieStore",function(e,t,o){var n=this;n.setCredentials=function(n){var a="token";t.globals={currentUser:{username:n.username,fullname:n.fullname,email:n.email,color:n.color,uid:n.uid,followees:JsonToArray(n.followees),authdata:a}};JsonToArray(t.globals.currentUser.followees);o.put("globals",t.globals),e.defaults.headers.common["x-auth"]=a},n.clearCredentials=function(){t.globals={},o.remove("globals"),e.defaults.headers.common.Authorization=null},n.validUserName=function(e,t){firebase.database().ref("/jb_usernames").once("value").then(function(o){var n=!0,a=o.val();if(a){var r=JsonToArray(a);r.indexOf(e)>-1&&(n=!1)}t(n)})},n.isFollowing=function(e){var o=t.globals.currentUser.followees;return o.indexOf(e)>-1},n.follow=function(e){t.globals.currentUser.followees.indexOf(e)<=-1&&(t.globals.currentUser.followees.push(e),o.remove("globals"),o.put("globals",t.globals))},n.unFollow=function(e){var n=t.globals.currentUser.followees;index=n.indexOf(e),index>-1&&(n[index]=""),t.globals.currentUser.followees=n,o.remove("globals"),o.put("globals",t.globals)},n.notify=function(e,t,o,n,a,r){var s={senderId:e,senderUsername:t,message:o,key:"",seen:!1,time:a,itemId:r},i=firebase.database().ref("users/"+n+"/notifications").push().key;s.key=i,firebase.database().ref().child("users/"+n+"/notifications/"+i).set(s)}}]);